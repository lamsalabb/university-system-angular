<main class="page-container">
  <div class="list-header">
    <h3 class="list-title">User Management</h3>
    <a
      class="primary-button small-button"
      routerLink="/admin/register-user"
    >
      Register User
    </a>
  </div>

  <div class="list-card">
    @if (error()) {
      <p class="error-text">{{ error() }}</p>
    }

    <table class="data-table">
      <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Status</th>
        <th class="align-right">Actions</th>
      </tr>
      </thead>

      <tbody>
        @if (loading()) {
          <tr>
            <td class="empty-row" colspan="5">
              Loading usersâ€¦
            </td>
          </tr>
        }

        @if (!loading() && users().length === 0) {
          <tr>
            <td class="empty-row" colspan="5">
              No users found.
            </td>
          </tr>
        }

        @for (u of users(); track u.id) {
          <tr>
            <td>{{ u.firstName }} {{ u.lastName }}</td>
            <td>{{ u.email }}</td>

            <td>
              <span class="status-badge neutral">
                {{ u.role }}
              </span>
            </td>

            <td>
              <span
                [class.danger]="!u.active"
                [class.success]="u.active"
                class="status-badge"
              >
                {{ u.active ? 'Active' : 'Inactive' }}
              </span>
            </td>

            <td class="align-right">
              @if (u.role !== 'ADMIN') {
                <button (click)="openEdit(u)" class="link-button">Edit</button>
                <button (click)="deleteUser(u.id)" class="link-button danger">Delete</button>
              }

              @if (u.role === 'ADMIN') {
                <span class="muted-text small-italic">Admin</span>
              }
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  @if (editingUser()) {
    <div (click)="closeEdit()" class="modal-backdrop">
      <div (click)="$event.stopPropagation()" class="modal-box">
        <h5 class="modal-title">Edit User</h5>

        <div class="form-field">
          <label class="form-label">First Name</label>
          <input [(ngModel)]="editForm.firstName" class="form-input">
        </div>

        <div class="form-field">
          <label class="form-label">Last Name</label>
          <input [(ngModel)]="editForm.lastName" class="form-input">
        </div>

        <div class="form-field">
          <label class="form-label">Email</label>
          <input [(ngModel)]="editForm.email" class="form-input" type="email">
        </div>

        <div class="form-field">
          <label class="form-label">New Password</label>
          <input
            [(ngModel)]="editForm.password"
            class="form-input"
            placeholder="Optional"
            type="password"
          >
        </div>

        @if (editingUser()?.role !== 'ADMIN') {
          <label class="checkbox-field">
            <input [(ngModel)]="editForm.isActive" type="checkbox">
            Active
          </label>
        }

        <div class="form-actions">
          <button (click)="closeEdit()" class="secondary-button small-button">Cancel</button>
          <button
            (click)="saveEdit()"
            [disabled]="!canSaveUser()"
            class="primary-button small-button"
          >
            Save
          </button>
        </div>
      </div>
    </div>
  }

  <app-pagination
    (pageChange)="currentPage.set($event)"
    (sizeChange)="pageSize.set($event); currentPage.set(0)"
    [loading]="loading()"
    [page]="currentPage()"
    [size]="pageSize()"
    [total]="totalElements()"
  ></app-pagination>
</main>

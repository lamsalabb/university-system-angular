<main class="page-container">
  <div class="list-header">

    <h3 class="list-title">Course Management</h3>

    <div>
      <a
        class="primary-button small-button"
        routerLink="/admin/register-course"
      >
        Create Course
      </a>
      &nbsp;
      <a
        (click)="openDistribution()"
        class="primary-button small-button"
      >
        View Distribution
      </a>
      &nbsp;
      <a
        (click)="generateReportPdf()"
        class="primary-button small-button"
      >
        Download Grade Report
      </a>
    </div>


  </div>

  @if (loading()) {
    <p class="muted-text">Loading courses…</p>
  }

  @if (error()) {
    <p class="error-text">{{ error() }}</p>
  }

  @if (!loading() && !error()) {
    <div class="list-card">
      <table class="data-table">
        <thead>
        <tr>
          <th>Title</th>
          <th>Code</th>
          <th>Credits</th>
          <th>Cost</th>
          <th>Instructor</th>
          <th class="align-right">Actions</th>
        </tr>
        </thead>

        <tbody>
          @for (c of courses(); track c.id) {
            <tr>
              <td>{{ c.title }}</td>
              <td>{{ c.code }}</td>
              <td>{{ c.credits }}</td>
              <td>{{ c.cost }}</td>
              <td>{{ c.instructorName }}</td>

              <td class="align-right">
                <div class="action-group">
                  <button
                    (click)="openEdit(c)"
                    class="link-button"
                  >
                    Edit
                  </button>

                  <button
                    (click)="openDetails(c.id)"
                    class="link-button"
                  >
                    Details
                  </button>

                  <button
                    (click)="deleteCourse(c.id)"
                    class="link-button danger"
                  >
                    Delete
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  @if (editingCourse()) {
    <div (click)="closeEdit()" class="modal-backdrop">
      <div (click)="$event.stopPropagation()" class="modal-box">
        <h5 class="modal-title">Edit Course</h5>

        <div class="form-field">
          <label class="form-label">Title</label>
          <input [(ngModel)]="editForm.title" class="form-input">
        </div>

        <div class="form-field">
          <label class="form-label">Code</label>
          <input [(ngModel)]="editForm.code" class="form-input">
        </div>

        <div class="form-field">
          <label class="form-label">Credits</label>
          <input [(ngModel)]="editForm.credits" class="form-input" type="number">
        </div>

        <div class="form-field">
          <label class="form-label">Cost</label>
          <input [(ngModel)]="editForm.cost" class="form-input" type="number">
        </div>

        <div class="form-field">
          <label class="form-label">Description</label>
          <input [(ngModel)]="editForm.description" class="form-input">
        </div>

        <div class="form-field">
          <label class="form-label">Instructor</label>
          <select [(ngModel)]="editForm.instructorId" class="form-input">
            @for (i of instructors; track i.id) {
              <option [value]="i.id">
                {{ i.firstName }} {{ i.lastName }}
              </option>
            }
          </select>
        </div>

        <div class="form-actions">
          <button (click)="closeEdit()" class="secondary-button small-button">
            Cancel
          </button>

          <button
            (click)="saveEdit()"
            [disabled]="!canSaveCourse()"
            class="primary-button small-button"
          >
            Save
          </button>
        </div>
      </div>
    </div>
  }

  @if (detailsCourse()) {
    <div (click)="closeDetails()" class="modal-backdrop">
      <div (click)="$event.stopPropagation()" class="modal-box">
        <h5 class="modal-title">Students Enrolled</h5>

        <div class="details-grid">

          @for (e of studentsEnrolled(); track e.id) {
            <div>
              <span>{{ e.student.firstName }} {{ e.student.lastName }}</span>
            </div>
          }

          <div class="form-actions">
            <button (click)="closeDetails()" class="primary-button small-button">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (showDistribution()) {
    <div (click)="closeDistribution()" class="modal-backdrop">
      <div (click)="$event.stopPropagation()" class="modal-box large">

        <h5 class="modal-title">Course Enrollment Distribution</h5>

        @if (!distributionChartData()) {
          <p class="muted-text">Loading distribution…</p>
        }

        @if (distributionChartData()) {
          <div style="height: 320px;">
            <canvas
              [data]="distributionChartData()"
              [options]="{
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom' } }
            }"
              [type]="'pie'"
              baseChart
            ></canvas>
          </div>
        }

        <div class="form-actions">
          <button
            (click)="closeDistribution()"
            class="secondary-button small-button"
          >
            Close
          </button>
        </div>

      </div>
    </div>
  }

</main>

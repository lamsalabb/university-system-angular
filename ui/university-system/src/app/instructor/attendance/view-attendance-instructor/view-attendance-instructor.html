<main class="page-container">

  <div class="list-header">
    <div>
      <h3 class="list-title">Attendance Records</h3>
      <span class="muted-text">View & update student attendance</span>
    </div>

    <button
      (click)="goToMarkAttendance()"
      class="primary-button"
      style="padding: 0.6rem 1.25rem; font-size: 0.95rem;"
    >
      Mark Attendance
    </button>


  </div>

  <div class="list-card">

    @if (summary()) {
      <div class="summary-section">

        <div class="summary-chart">
          <canvas
            [data]="chartData()"
            [type]="'pie'"
            baseChart>
          </canvas>
        </div>

        <div class="summary-stats">
          <div>Total Sessions: {{ summary().totalSessions }}</div>
          <div>Present: {{ summary().presentCount }}</div>
          <div>Absent: {{ summary().absentCount }}</div>
          <div>Excused: {{ summary().excusedCount }}</div>
          <strong>
            Attendance: {{ summary().presentPercent | number:'1.0-2' }}%
          </strong>
        </div>

      </div>
    }

    <div class="course-buttons">
      @for (c of courses(); track c.id) {
        <button
          (click)="loadAttendance(c.id)"
          [class.active]="selectedCourseId() === c.id"
          class="secondary-button small-button"
        >
          {{ c.title }}
        </button>
      }
    </div>

    <table class="data-table">

      <thead>
      <tr>
        <th>Student</th>
        <th>Date</th>
        <th class="center">Status</th>
        <th class="center">Update Status</th>
      </tr>
      </thead>

      <tbody>

        @if (!selectedCourseId()) {
          <tr>
            <td class="empty-row" colspan="4">
              Select a course to view attendance.
            </td>
          </tr>
        }

        @if (selectedCourseId() && attendance().length === 0) {
          <tr>
            <td class="empty-row" colspan="4">
              No attendance records found for this course.
            </td>
          </tr>
        }

        @for (a of attendance(); track a.id) {
          <tr>

            <td>
              {{ a.student.firstName }}
              {{ a.student.lastName }}
            </td>

            <td>{{ a.sessionDate }}</td>

            <td class="center">
              <span
                [class.danger]="a.status === 'ABSENT'"
                [class.success]="a.status === 'PRESENT'"
                [class.warning]="a.status === 'EXCUSED'"
                class="status-badge"
              >
                {{ a.status }}
              </span>
            </td>

            <td class="center">
              <form
                (ngSubmit)="updateAttendance(a.id, a.status)"
                class="inline-form"
                style="gap: 0.75rem;"
              >

                <select
                  [(ngModel)]="a.status"
                  class="form-input"
                  name="status-{{ a.id }}"
                  style="min-width: 110px; padding: 0.35rem 0.5rem; font-size: 0.85rem;"
                >
                  <option value="PRESENT">PRESENT</option>
                  <option value="ABSENT">ABSENT</option>
                  <option value="EXCUSED">EXCUSED</option>
                </select>

                <button
                  class="primary-button small-button"
                  style="padding: 0.35rem 0.75rem;"
                  type="submit"
                >
                  Save
                </button>

              </form>
            </td>

          </tr>

        }

      </tbody>

    </table>

  </div>

  @if (selectedCourseId()) {
    <app-pagination
      (pageChange)="currentPage.set($event)"
      (sizeChange)="pageSize.set($event); currentPage.set(0)"
      [loading]="loading()"
      [page]="currentPage()"
      [size]="pageSize()"
      [total]="totalElements()"
    ></app-pagination>
  }


</main>
